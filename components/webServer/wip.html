<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="UTF-8" />
    <title>Current Conditions</title>

    <link href="magnum_style.css" rel="stylesheet" type="text/css" />
    <!-- <link rel="icon" type="images/favicon" href="res/images/favicon.gif" /> -->
  </head>
  <body
    style="
      background-color: #ffffff;
      margin-top: 0px;
      margin-left: 0px;
      margin-right: 0px;
    "
  >
    <div
      id="wrapper"
      style="
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        background-color: #ffffff;
      "
    >
      <div class="navBarCon">
        <ul
          style="
            border: none;
            width: 100%;
            border-spacing: 0px;
            list-style-type: none;
          "
        >
          <li>
            <a href="/">Current Conditions</a>
          </li>
          <!-- <li>
            <a href="currentSettings.html">Current Settings</a>
          </li>
          <li style="width: 34%">
            <a href="historical.html">Historical Data</a>
          </li> -->
        </ul>
      </div>
    </div>
    <div style="text-align: center">
      <h1 id="headline">Current Conditions</h1>
      <!--Note: This server will be down for scheduled maintenance from 7PM to 9PM CST today.-->

      <br />
    </div>

    <script>
      if (!window.console) {
        console = { log: function () {} };
      } //IE doesn't like calls to console if debugger is not open
    </script>

    <script type="text/javascript" src="jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="excanvas.min.js"></script>

    <script type="text/javascript" src="jquery.flot.js"></script>
    <script type="text/javascript" src="jquery.flot.threshold.js"></script>
    <script type="text/javascript" src="howler.min.js"></script>
    <script type="text/javascript" src="alarm.js"></script>
    <script type="text/javascript" src="date.js"></script>
    <script type="text/javascript" src="magnum.js"></script>
    <script type="text/javascript">
      var seconds = 0;
      var dec = 1;
      var hoverSOC = false;
      var hoverVolts = false;
      var hoverAmp = false;
      var lastTime = 0;
      var nowTimeStamp = 0;
      var chrgLED = 0;
      var invLED = 0;
      var dayKB = 2 * 1000;
      var isIE = msieversion();
      var channels;
      var curTime;

      /* This script kindly provided by Microsoft */
      function msieversion() {
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");

        if (msie > 0)
          // If Internet Explorer, return version number
          return parseInt(ua.substring(msie + 5, ua.indexOf(".", msie)));
        // If another browser, return 0
        else return 0;
      }
      /* saves the channel data to an object that can be referenced anywhere */
      function loadChannelData() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              dataS = $.parseJSON(xhr.responseText);
              channels = dataS.data;
              //Commented out because we don't have logging for now
              // loadHistory();
              loadDataCreate();
            } else {
              console.error("Error:", xhr.status);
              noResponse = true;
              customFaults(null);
            }
          }
        };
        xhr.open("GET", "/channel.json", true);
        xhr.send();
      }

      /* headline */
      function updateHeadline() {
        //urlHostname = "http://192.168.10.226/data/hostinfo.json?_=1415809551047";
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              var jsonData = JSON.parse(xhr.responseText); // Parse the JSON response
              processHostInfo(jsonData, false);
            } else {
              console.error("Error:", xhr.status);
            }
          }
        };
        xhr.open("GET", "/hostinfo.json", true);
        xhr.send();
      }
      /* headline */
      function loadHeadline() {
        //urlHostname = "http://192.168.10.226/data/hostinfo.json?_=1415809551047";

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              var jsonData = JSON.parse(xhr.responseText); // Parse the JSON response
              processHostInfo(jsonData, true);
            } else {
              console.error("Error:", xhr.status);
            }
          }
        };
        xhr.open("GET", "/hostinfo.json", true);
        xhr.send();
      }

      //TODO: maybe modify it so that it only contains the mnt data instead of having everything?
      function processHostInfo(dataS, create) {
        $("#headline").html(dataS.hostname + ": Current Conditions");

        var total = getMemory("/mnt/data", "total", dataS.drives);
        var free = getMemory("/mnt/data", "avail", dataS.drives);
        var used = getMemory("/mnt/data", "used", dataS.drives);
        var daysLeft = total / dayKB;

        if (-1 != total) {
          addLineMem(
            "memTable",
            "Total Space:",
            commaSeparateNumber((total / 1000).toFixed(0)) + " MB",
            "total_space",
            create
          );
          addLineMem(
            "memTable",
            "Free Space:<br>Percent:",
            formatMem(free, total),
            "free_space",
            create
          );
          addLineMem(
            "memTable",
            "Used Space:<br>Percent:",
            formatMem(used, total),
            "used_space",
            create
          );
          addLineMem(
            "memTable",
            'Days Left:<br><span style="font-size: .75em">approximate</span>',
            commaSeparateNumber((total / dayKB).toFixed(0)),
            "days_left",
            create
          );
        } else {
          $("#memoryData").hide();
        }
        /* if USB is plugged in */
        if (-1 != getMemory("/media/usb0", "total", dataS.drives)) {
          $(".usbRow").show();

          /* safe to remove? */
          var readOnly = getMemory("/media/usb0", "readOnly", dataS.drives);
          if (!readOnly) {
            $("#usbMsg").html(
              "File copy in progess<br>DO NOT REMOVE<br>EXTERNAL STORAGE</span>"
            );
            $("#usbMsg").css("background-color", "red");
            $("#usbMsg").css("color", "white");
            MemUp();
          } else {
            $("#usbMsg").html(
              "File copy is complete.<br>You may safely remove<br>external storage</span>"
            );
            $("#usbMsg").css("background-color", "green");
            $("#usbMsg").css("color", "white");
          }
        } else {
          $(".usbRow").hide();
        }

        /* warning if low on space */
        if (daysLeft <= 30) {
          $("#memWarn").show();
        } else {
          $("#memWarn").hide();
        }
      }

      function getMemory(driveName, statName, drives) {
        for (var i = 0; i < drives.length; i++) {
          if (-1 != drives[i]["description"].indexOf(driveName)) {
            return drives[i][statName];
          }
        }
        return "-1";
      }

      function formatMem(mem, total) {
        return (
          commaSeparateNumber((mem / 1000).toFixed(0)) +
          " MB<br>" +
          ((mem / total) * 100).toFixed(0) +
          "%"
        );
      }

      /* returns oject with channel information */
      function getChObj(channel) {
        for (var i = 0; i < channels.length; i++) {
          if (channels[i].id == channel) return channels[i];
        }
        return null;
      }
      /* returns the unit of a channel with an option space */
      function getChUnit(channel, space) {
        var obj = getChObj(channel);
        if (null == obj) return "";
        return space + obj.units;
      }

      var dataAr = [];

      var lastCh = "";

      /* loads ten second data */
      function loadDataCreate() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              dataS = $.parseJSON(xhr.responseText);
              loadTime(dataS, true);
              //   createTable(dataS, true);
            } else {
              console.error("Error:", xhr.status);
              noResponse = true;
              customFaults(null);
            }
          }
        };
        xhr.open("GET", "/dataNow.json", true);
        xhr.send();
      }

      function loadData() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              dataS = $.parseJSON(xhr.responseText);
              loadTime(dataS, false);
              //   createTable(dataS, false);
            } else {
              console.error("Error:", xhr.status);
              noResponse = true;
              customFaults(null);
            }
          }
        };
        xhr.open("GET", "/dataNow.json", true);
        xhr.send();
      }

      /* creates the current table */
      function createTable(dataNow, create) {
        $.each(dataNow.data, function (key, value) {
          dataAr[value.channel] = value;
          lastCh = value.channel;
        });

        if (create) $("#currentTable").html("");

        if (dataNow.data.length != 0) {
          noData = false;
          noResponse = false;
          /* Check for faults */
          customFaults(dataAr);

          /* Data date row */
          dateRows(dataAr, create);

          /* BMK rows */
          batteryCharts(dataAr, create);
          batteryRows(dataAr, create);
          if (parseInt(dataAr["age_bmk"].sampleValue) < 100) {
            updatePlotArrays(dataAr, create);
          } else {
            $("#loadingMsg").hide();
          }
          /* Inverter rows */
          inverterRows(dataAr, create);

          /* AGS rows */
          agsRows(dataAr, create);

          /* 24hour data */
          //dailyStats(dataAr,create);
          // loadDayData(dataAr,create); //TODO: This is removed for now since we don't have 24 hours data

          /* plot graphs */
          if (create && parseInt(dataAr["age_bmk"].sampleValue) < 100)
            plotGraphs();

          /* start page timer */
          if (create) {
            location.href = "#tables";
            timerTick();
          }
        } else {
          noData = true;
          customFaults(null);
        }
      }

      //FIXME: this is only a temporary solution for ethernet example
      function loadTime(dataS, bol) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              curTime = $.parseJSON(xhr.responseText).data;
              createTable(dataS, bol);
            } else {
              console.error("Error:", xhr.status);
              noResponse = true;
              customFaults(null);
            }
          }
        };
        xhr.open("GET", "/getTime", true);
        xhr.send();
      }

      /* create the human readable received report */
      function dateRows(dataAr, create) {
        addHeader("currentTable", "Now", 2, create);

        /* There isn't any kind of age indication in these packets as of now, so we have to remember the last packet time and check against that */

        //FIXME: This is modified to be used in ethernet example
        console.log(
          `Current time is ${curTime} and the type is ${typeof curTime}`
        );
        curTime = parseInt(curTime);
        if (255 == parseInt(dataAr["age_inverter"].sampleValue)) {
          if (lastTime != curTime) {
            seconds = 0;
            lastTime = curTime;
            oldData = false;
          } else if (seconds > 30) {
            oldData = true;
            customFaults(null);
          }
        } else {
          if (lastTime != curTime) {
            seconds = 0;
            lastTime = curTime;
            oldData = false;
          } else if (seconds > 10) {
            oldData = true;
            customFaults(null);
          }
        }
        lastTime = curTime;
        nowTimeStamp = curTime;

        addLine(
          "currentTable",
          "Data Date (UTC):",
          '<span id="convDate">' +
            getUTCTime(curTime) +
            '</span><br>Report received <span id="ageRep">' +
            commaSeparateNumber(seconds) +
            "</span> seconds ago",
          "date",
          create
        );
      }

      /* battery monitor charts */
      function batteryCharts(dataAr, create) {
        if (parseInt(dataAr["age_bmk"].sampleValue) < 100) {
          addCat(
            "currentTable",
            "Data Supplied By Battery Monitor (ME-BMK)",
            create
          );

          addLine(
            "currentTable",
            "Battery Volts:",
            dataAr["b_dc_volts"].avg.toFixed(getChObj("b_dc_volts").precision) +
              " VDC",
            "b_dc_volts",
            create
          );
          addLine(
            "currentTable",
            "Battery Amps:",
            dataAr["b_dc_amps"].avg.toFixed(getChObj("b_dc_amps").precision) +
              " amps",
            "b_dc_amps",
            create
          );
          addLine(
            "currentTable",
            "Battery Watts:",
            dataAr["b_dc_watts"].avg.toFixed(getChObj("b_dc_watts").precision) +
              " watts",
            "b_dc_watts",
            create
          );
          //addLine("currentTable",'Renewable Watts:<br><span style=\"font-size:.75em;\">(Approximate Value +/- 50W)</span>',dataAr['calc_add_power'].avg.toFixed(getChObj("calc_add_power").precision)+" watts","calc_add_power", create);

          addLine(
            "currentTable",
            'Battery State of Charge:<br><span style="font-size:.75em;">(10 minute averages over past 24 hours)<br>Gray Bars Indicate Thinking</span>',
            '<span id="battCharge">Loading...</span><br>' +
              '<div style="width: 100%;height: 70px;padding: 00px 00px 00px 00px;margin-left:auto;margin-right:auto;">' +
              '<div id="chargeChart" style="width: 100%;height: 100%;font-size: 14px;line-height: 1em;"  ></div>' +
              "</div>" +
              '<span id="SOCTicks" style="font-size:.8em"></span>',
            "battSOCCell",
            create
          );

          addLine(
            "currentTable",
            'Battery Watts In/Out:<br><span style="font-size:.75em;">(10 minute averages over past 24 hours)</span>',
            '<div style="width: 100%;height: 70px;padding: 00px 00px 00px 00px;margin-left:auto;margin-right:auto;">' +
              '<div id="voltsChart" style="width: 100%;height: 100%;font-size: 14px;line-height: 1em;"  ></div>' +
              "</div>" +
              '<span id="SOCTicks" style="font-size:.8em"></span>',
            "voltsAmpsCell",
            create
          );

          addLine(
            "currentTable",
            'Battery Amp Hours In / Out:<br><span style="font-size:.75em;">(10 minute averages over past 24 hours)</span>',
            '<span id="ampHours">Loading...</span><br>' +
              '<div style="width: 100%;height: 70px;padding: 00px 00px 00px 00px;margin-left:auto;margin-right:auto;">' +
              '<div id="ampChart" style="width: 100%;height: 100%;font-size: 14px;line-height: 1em;"  ></div>' +
              "</div>" +
              '<span id="SOCTicks" style="font-size:.8em"></span>',
            "ampHoursCell",
            create
          );

          /*	addLine("currentTable","Renewable Watts:<br><span style=\"font-size:.75em;\">(10 minute averages over past 24 hours)</span>",
      				"<div style=\"width: 100%;height: 70px;padding: 00px 00px 00px 00px;margin-left:auto;margin-right:auto;\">"+
      					"<div id=\"calcChart\" style=\"width: 100%;height: 100%;font-size: 14px;line-height: 1em;\"  ></div>"+
      				"</div>"+
      				"<span id=\"SOCTicks\" style=\"font-size:.8em\"></span>","calcCell", create);
      	*/

          if (!create) plotGraphs();
        }
      }

      /* battery monitor rows */
      function batteryRows(dataAr, create) {
        if (parseInt(dataAr["age_bmk"].sampleValue) < 100) {
          if (dataAr["b_state_of_charge"].avg <= 100) {
            $("#battCharge").html(
              dataAr["b_state_of_charge"].avg.toFixed(0) + "%"
            );
          } else {
            $("#battCharge").html("Thinking...");
          }
          var watts = Math.round(
            dataAr["b_dc_volts"].avg * dataAr["b_dc_amps"].avg
          );

          $("#voltsAmps").html(
            commaSeparateNumber(
              dataAr["b_dc_volts"].avg.toFixed(getChObj("b_dc_volts").precision)
            ) +
              " VDC @ " +
              commaSeparateNumber(
                dataAr["b_dc_amps"].avg.toFixed(getChObj("b_dc_amps").precision)
              ) +
              " amps (" +
              commaSeparateNumber(watts) +
              " watts)"
          );

          $("#ampHours").html(
            commaSeparateNumber(
              parseFloat(dataAr["b_amph_in_out"].sampleValue).toFixed(
                getChObj("b_amph_in_out").precision
              )
            ) + " amp hours"
          );
        } else {
          $("#battCharge").html("No Data From BMK. Chart did not update");
          $("#voltsAmps").html("No Data From BMK. Chart did not update");
          $("#ampHours").html("No Data From BMK. Chart did not update");
        }
      }

      /* inverter rows */
      function inverterRows(dataAr, create) {
        if (parseInt(dataAr["age_inverter"].sampleValue) < 200) {
          /* Add category header */
          addCat(
            "currentTable",
            "Data Supplied By Inverter (" +
              magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 0) +
              ")",
            create
          );

          /* Status */
          addLine(
            "currentTable",
            "Status:",
            magnumInverterStatus(parseInt(dataAr["i_status"].sampleValue)),
            "iStatus",
            create
          );

          addLine(
            "currentTable",
            "Battery Temperature:",
            magnumTemperature(dataAr["i_temp_battery"].avg),
            "batTemp",
            create
          );
          addLine(
            "currentTable",
            "Transformer Temperature:",
            magnumTemperature(dataAr["i_temp_transformer"].avg),
            "i_tempTransformer",
            create
          );
          addLine(
            "currentTable",
            "FET Temperature:",
            magnumTemperature(dataAr["i_temp_fet"].avg),
            "i_tempFet",
            create
          );

          /* AC output voltage is displayed if appropriate length even if export
      		no AC current if export */

          var displayMeters = false;
          if (
            (null == dataAr["length_inverter"] ||
              parseInt(dataAr["length_inverter"].sampleValue) >= 20) &&
            magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 3) != 1
          ) {
            displayMeters = true;
          }

          var exportMeters = false;
          var vacScale = 1.0;
          if (
            !displayMeters &&
            parseInt(dataAr["length_inverter"].sampleValue) >= 20
          ) {
            exportMeters = true;

            if (
              1 ==
              magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 3)
            ) {
              vacScale = 2.0;
            }

            /* AC out */
            var s;
            if (dataAr["i_ac_volts_out"].avg >= 80) {
              s =
                magnumExportVoltageScale(
                  dataAr["i_ac_volts_out"].avg,
                  vacScale
                ).toFixed(getChObj("i_ac_volts_out").precision) + " volts AC";
            } else {
              s = "Inactive.";
            }
            addLine("currentTable", "AC Out:", s, "i_acOut", create);
          }

          if (displayMeters) {
            /*
      			//dataAr["i_amps_out"].avg = 123;

      			if ( parseFloat(dataAr["r_revision"].sampleValue) < 4 ) {
      				if ( dataAr["i_amps_out"].avg >= 0 ){
      					dataAr["i_amps_out"].avg = 128-dataAr["i_amps_out"].avg;
      				}
      			}
      			*/

            /* AC out */
            var s;
            if (dataAr["i_ac_volts_out"].avg >= 80) {
              s =
                "Approximately " +
                magnumExportVoltageScale(
                  dataAr["i_ac_volts_out"].avg,
                  vacScale
                ).toFixed(getChObj("i_ac_volts_out").precision) +
                " volts";
              addLine(
                "currentTable",
                "AC Out Volts:",
                s,
                "ac_out_volts",
                create
              );
              if (
                1 ==
                magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 4)
              ) {
                s =
                  "Approximately " +
                  dataAr["i_amps_out"].avg.toFixed(
                    getChObj("i_amps_out").precision
                  ) +
                  " amps";
                addLine(
                  "currentTable",
                  "AC Out Amps:",
                  s,
                  "ac_out_amps",
                  create
                );
                addLine(
                  "currentTable",
                  "AC Out Watts:",
                  "Approximately " +
                    (
                      dataAr["i_ac_volts_out"].avg * dataAr["i_amps_out"].avg
                    ).toFixed(0) +
                    " watts",
                  "ac_out_watts",
                  create
                );
              }

              //addLine("currentTable",'AC Out Volts:',s,"ac_out_volts", create );
              //addLine("currentTable",'AC Out Amps:',s , "ac_out_amps", create );
              //addLine("currentTable",'AC Out Watts:',(dataAr["i_ac_volts_out"].avg*dataAr["i_amps_out"].avg).toFixed(0) ,"ac_out_watts", create );
            } else {
              s = "Inactive.";
              addLine(
                "currentTable",
                "AC Out Volts:",
                s,
                "ac_out_volts",
                create
              );
              addLine("currentTable", "AC Out Amps:", s, "ac_out_amps", create);
              addLine(
                "currentTable",
                "AC Out Watts:",
                s,
                "ac_out_watts",
                create
              );
            }
            //addLine("currentTable",'AC Out:',s,"i_acOut", create);

            /* AC in */
            if (
              dataAr["i_ac_volts_in"].avg >= 80 &&
              1 ==
                magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 4)
            ) {
              s =
                "Approximately " +
                dataAr["i_ac_volts_in"].avg.toFixed(
                  getChObj("i_ac_volts_in").precision
                ) +
                " volts";
              addLine("currentTable", "AC In Volts:", s, "ac_in_volts", create);
              addLine(
                "currentTable",
                "AC In Amps:",
                "Approximately " +
                  dataAr["i_amps_in"].avg.toFixed(
                    getChObj("i_amps_in").precision
                  ),
                "ac_in_amps",
                create
              );
              addLine(
                "currentTable",
                "AC In Watts:",
                "Approximately " +
                  (
                    dataAr["i_amps_in"].avg * dataAr["i_ac_volts_in"].avg
                  ).toFixed(0),
                "ac_in_watts",
                create
              );
              //console.log("dfd");
              $("#row_ac_in_amps").show();
              $("#row_ac_in_watts").show();
            } else {
              s = "Inactive.";
              addLine("currentTable", "AC In Volts:", s, "ac_in_volts", create);
              addLine("currentTable", "AC In Amps:", s, "ac_in_amps", create);
              addLine("currentTable", "AC In Watts:", s, "ac_in_watts", create);
              $("#row_ac_in_amps").hide();
              $("#row_ac_in_watts").hide();
            }

            //addLine("currentTable",'AC In:',s,"i_acIn", create);

            /* AC frequency */
            addLine(
              "currentTable",
              'AC Frequency: <span style="font-size: 0.8em;">(Hz)</span>',
              dataAr["i_ac_hz"].avg.toFixed(getChObj("i_ac_hz").precision),
              "i_acFreq",
              create
            );

            /* DC volts / amps */
            if (
              parseInt(dataAr["age_bmk"].sampleValue > 250) ||
              "1" != dataAr["b_fault"].sample
            ) {
              //echo magnumGetSparkHTML($station_id,'i_watts',$hours);
              //echo "<br>";
            }
            s =
              dataAr["i_dc_volts"].avg.toFixed(
                getChObj("i_dc_volts").precision
              ) +
              " VDC @ " +
              dataAr["i_dc_amps"].avg.toFixed(getChObj("i_dc_amps").precision) +
              " amps (" +
              (dataAr["i_dc_volts"].avg * dataAr["i_dc_amps"].avg).toFixed(0) +
              " watts)";
            addLine(
              "currentTable",
              'DC volts / amps:<br><span style="font-size: 0.8em;">(Values are approximate)</span>',
              s,
              "i_dcVoltsAmps",
              create
            );
          }
        }
      }

      /* ags rows */
      function agsRows(dataAr, create) {
        if (parseInt(dataAr["age_ags_0xA1"].sampleValue) < 100) {
          addCat("currentTable", "AGS / Generator", create);

          addLine(
            "currentTable",
            "Status:",
            magnumAGSStatus(parseInt(dataAr["a_status"].sampleValue)),
            "ags_status",
            create
          );
          addLine(
            "currentTable",
            "AGS Temperature:",
            magnumAGSTemperature(dataAr["a_temperature"].avg),
            "ags_temp",
            create
          );
          addLine(
            "currentTable",
            "AGS Voltage:",
            dataAr["a_voltage"].avg.toFixed(getChObj("a_voltage").precision) +
              " VDC",
            "ags_volt",
            create
          );

          addLine(
            "currentTable",
            'Generator Runtime:<br><span style="font-size: 0.8em;">(Current Cycle)</span>',
            parseFloat(dataAr["a_gen_runtime_minutes"].sampleValue).toFixed(1) +
              " hours",
            "ags_genRun",
            create
          );

          addLine(
            "currentTable",
            "Days Since Last Run:",
            parseInt(dataAr["a_days_since_last"].sampleValue) + " days",
            "ags_daysSince",
            create
          );

          addLine(
            "currentTable",
            'Total Generator Runtime:<br><span style="font-size: 0.8em;"> (Since AGS Boot)</span>',
            parseInt(dataAr["a_gen_run_hours_since_boot"].sampleValue) +
              " hours",
            "ags_genRunHours",
            create
          );
        } else {
          addCat("currentTable", "AGS / Generator", false);

          addLine("currentTable", "Status:", "No Data", "ags_status", false);
          addLine(
            "currentTable",
            "AGS Temperature:",
            "No Data",
            "ags_temp",
            false
          );
          addLine("currentTable", "AGS Voltage:", "No Data", "ags_volt", false);
          addLine(
            "currentTable",
            'Generator Runtime:<br><span style="font-size: 0.8em;">(Current Cycle)</span>',
            "No Data",
            "ags_genRun",
            false
          );
          addLine(
            "currentTable",
            "Days Since Last Run:",
            "No Data",
            "ags_daysSince",
            false
          );
          addLine(
            "currentTable",
            'Total Generator Runtime:<br><span style="font-size: 0.8em;"> (Since AGS Boot)</span>',
            "No Data",
            "ags_genRunHours",
            false
          );
        }
      }

      /* appends row to the given tableID */
      function addLine(tableID, name, val, id, create) {
        tableID = "#" + tableID;

        if (create) {
          $(tableID).append(
            '<tr id="row_' +
              id +
              '"><th class="right">' +
              name +
              '</th><td id="' +
              id +
              '">' +
              val +
              "</td></tr>"
          );
        } else {
          $("#" + id).html(val);
        }
      }
      /* appends a row to the memory table. The difference is the th class. */
      function addLineMem(tableID, name, val, id, create) {
        tableID = "#" + tableID;

        if (create) {
          $(tableID).append(
            '<tr><th class="rightMem">' +
              name +
              '</th><td id="' +
              id +
              '">' +
              val +
              "</td></tr>"
          );
        } else {
          $("#" + id).html(val);
        }
      }

      /* appends header to the given tableID */
      function addHeader(tableID, title, rows, create) {
        tableID = "#" + tableID;
        if (create)
          $(tableID).append(
            '<tr><th colspan="' +
              rows +
              '" style="font-size: 1.5em;">' +
              title +
              "</th></tr>"
          );
      }

      /* appends category label to the given tableID */
      function addCat(tableID, title, create) {
        tableID = "#" + tableID;
        if (create)
          $(tableID).append(
            '<tr><th class="table_header" colspan="2">' + title + "</th></tr>"
          );
      }

      function addHourCat(tableID, title, create) {
        tableID = "#" + tableID;
        if (create) {
          $(tableID).append(
            '<tr><th class="table_header" colspan="4">' +
              title +
              '<span id="inverterModel"></span></th></tr>'
          );
          $(tableID).append(
            "<tr><th></th>" +
              "<th>Minimum</th>" +
              "<th>Maximum</th>" +
              "<th>Average</th></tr>"
          );
        }
      }

      function updatePlotArrays(dataAr) {
        /* push new data into chart arrays */
        /* if isn't null and the time on the packet does not equal the time of the last pushed element */

        if (data.b_state_array.length != 0) {
          if (
            null != dataAr["b_state_of_charge"].avg &&
            dataAr["b_state_of_charge"].time !=
              data.b_state_array[data.b_state_array.length - 1][0]
          ) {
            data.b_state_array.push([
              dataAr["b_state_of_charge"].time,
              dataAr["b_state_of_charge"].avg,
            ]);
          }
          while (data.b_state_array[0][0] < dayAgo) {
            data.b_state_array.shift();
          }
        }
        if (data.b_watts.length != 0) {
          if (
            null != dataAr["b_dc_watts"].avg &&
            dataAr["b_dc_watts"].time !=
              data.b_watts[data.b_watts.length - 1][0]
          ) {
            data.b_watts.push([
              dataAr["b_dc_watts"].time,
              dataAr["b_dc_watts"].avg,
            ]);
          }
          while (data.b_watts[0][0] < dayAgo) {
            data.b_watts.shift();
          }
        }
        if (data.amp_in_out.length != 0) {
          if (
            null != dataAr["b_amph_in_out"].sampleValue &&
            dataAr["b_amph_in_out"].time !=
              data.amp_in_out[data.amp_in_out.length - 1][0]
          ) {
            data.amp_in_out.push([
              dataAr["b_amph_in_out"].time,
              dataAr["b_amph_in_out"].sampleValue,
            ]);
          }
          while (data.amp_in_out[0][0] < dayAgo) {
            data.amp_in_out.shift();
          }
        }
        if (data.calc.length != 0) {
          if (
            null != dataAr["calc_add_power"].avg &&
            dataAr["calc_add_power"].time != data.calc[data.calc.length - 1][0]
          ) {
            data.calc.push([
              dataAr["calc_add_power"].time,
              dataAr["calc_add_power"].avg,
            ]);
          }
          while (data.calc[0][0] < dayAgo) {
            data.calc.shift();
          }
        }
        /* if array has more than 24 hours of data, shift data out */

        var dayAgo = new Date().getTime() - 1000 * 60 * 60 * 24;
      }

      var battArray = [];
      var voltsArray = [];
      var ampArray = [];
      var calcArray = [];
      /* this data object will hold the arrays to be used in the charts. This is done to reuse the code from magnum-dev with minimal pain */
      var data = {
        b_state_array: [],
        b_watts: [],
        amp_in_out: [],
        calc: [],
      };

      function loadDayData(dataAr, create) {
        // If internet explorer, use Microsoft XDR
        if (isIE) {
          var xdr = new XDomainRequest();
          xdr.open("get", urlDay + "?t=" + new Date().getTime());

          xdr.onerror = function () {
            noResponse = true;
            customFaults(null);
          };
          xdr.onload = function () {
            dataS = $.parseJSON(xdr.responseText);

            processDayData(dataS, dataAr, create);
          };
          xdr.send();
        } else {
          /* if not IE we use ajax */

          $.ajaxSetup({ cache: false });
          $.ajax({
            type: "GET",
            url: urlDay,
            dataType: "html",
            crossDomain: true,
          }).done(function (dataS) {
            dataS = $.parseJSON(dataS);
            processDayData(dataS, dataAr, create);
          });
        }
      }

      function processDayData(dayData, dataAr, create) {
        if (create) $("#hourTable").html("");

        addHeader("hourTable", "24 Hour Data", 4, create);

        batteryHourRows(dayData, dataAr, create);
        inverterHourRows(dayData, dataAr, create);
        agsHourRows(dayData, dataAr, create);
      }

      function batteryHourRows(dayData, dataAr, create) {
        if (parseInt(dataAr["age_bmk"].sampleValue) < 100) {
          addHourCat(
            "hourTable",
            "Data Supplied By Battery Monitor (ME-BMK)",
            create
          );

          /* State Of Charge */
          addHourLineSpec(
            "hourTable",
            "b_state_of_charge_clean",
            "Battery State of Charge:",
            dayData.dayStats,
            create
          );

          /* DC Volts */
          addHourLine(
            "hourTable",
            "b_dc_volts_clean",
            "Battery Volts:",
            dayData.dayStats,
            create
          );

          /* DC Amps */
          addHourLine(
            "hourTable",
            "b_dc_amps_clean",
            "Battery Amps:",
            dayData.dayStats,
            create
          );

          /* DC Watts */
          addHourLine(
            "hourTable",
            "b_dc_watts",
            "Battery Watts:",
            dayData.dayStats,
            create
          );

          /* Calculated Renewable Power */
          //addHourLine("hourTable","calc_add_power","Renewable Watts:",dayData.dayStats,create );

          //updateHourWatts("b_dc_watts","DC Watts:", create);
          //updateHourWatts("hourTable","b_dc_watts","DC Watts:", dayData.dayStats,create);
        }
      }

      function inverterHourRows(dayData, dataAr, create) {
        if (parseInt(dataAr["age_inverter"].sampleValue) < 250) {
          addHourCat(
            "hourTable",
            "Data Supplied By Inverter (" +
              magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 0) +
              ")",
            create
          );
          /* if no BMK, then show inverter dc volts and amps */
          if (parseInt(dataAr["age_bmk"].sampleValue) > 250) {
            /* unfortunately, we aren't keeping track of this in the history json  */

            addHourLine(
              "hourTable",
              "i_dc_volts",
              "DC Volts:",
              dayData.dayStats,
              create
            );
            addHourLine(
              "hourTable",
              "i_dc_amps",
              "DC Amps:",
              dayData.dayStats,
              create
            );
          }
          var displayMeters = false;
          if (
            (null == dataAr["length_inverter"] ||
              parseInt(dataAr["length_inverter"].sampleValue) >= 20) &&
            magnumInverterModel(parseInt(dataAr["i_model"].sampleValue), 3) != 1
          ) {
            displayMeters = true;
          }
          var exportMeters = false;

          if (
            !displayMeters &&
            parseInt(dataAr["length_inverter"].sampleValue) >= 20
          ) {
            exportMeters = true;
          }
          if (displayMeters || exportMeters) {
            /* AC Volts Out ( when volts > 80 ) */

            addHourLine(
              "hourTable",
              "i_ac_volts_out_over_80",
              'AC volts Out:<br><span style="font-size: 0.8em;">(when volts &gt; 80)</span>',
              dayData.dayStats,
              create
            );
          }
          if (displayMeters) {
            /* if we see a null for i_amps_out, then inverter does not have meters */

            addHourLine(
              "hourTable",
              "i_amps_out_inverting",
              'AC amps Out:<br><span style="font-size: 0.8em;">(when not charging)</span>',
              dayData.dayStats,
              create
            );

            addHourLine(
              "hourTable",
              "i_amps_out_charging",
              'AC amps Out:<br><span style="font-size: 0.8em;">(when charging)</span>',
              dayData.dayStats,
              create
            );

            addHourLine(
              "hourTable",
              "i_amps_in_clean",
              "AC amps In:",
              dayData.dayStats,
              create
            );

            addHourLine(
              "hourTable",
              "i_ac_hz_clean",
              'AC Frequency: <span style="font-size: 0.8em;">(Hz)</span>',
              dayData.dayStats,
              create
            );
          }

          /* temperatures */

          updateHourRowTemp(
            "hourTable",
            "i_temp_battery_clean",
            "Battery Temperature:",
            dayData.dayStats,
            create
          );
          updateHourRowTemp(
            "hourTable",
            "i_temp_transformer_clean",
            "Transformer Temperature:",
            dayData.dayStats,
            create
          );
          updateHourRowTemp(
            "hourTable",
            "i_temp_fet_clean",
            "FET Temperature:",
            dayData.dayStats,
            create
          );
        }
      }

      /* 24 hour AGS data */
      function agsHourRows(dayData, dataAr, create) {
        if (parseFloat(dataAr["age_ags_0xA1"].sampleValue) < 250) {
          if ("0" == dataAr["a_status"].sampleValue) {
            addHourCat("hourTable", "AGS<br>(currently offline)", create);
          } else {
            addHourCat("hourTable", "AGS", create);
          }
          updateHourRowTempAGS(
            "hourTable",
            "a_temperature_clean",
            "AGS Temperature:",
            dayData.dayStats,
            create
          );
          addHourLine(
            "hourTable",
            "a_voltage_clean",
            'AGS Voltage: <span style="font-size: 0.8em;">(volts DC)</span>',
            dayData.dayStats,
            create
          );
        }
      }

      function updateHourRowTemp(tableID, id, title, val, create) {
        var obj = getChObj(id);
        var prec = 2;

        if (null != obj) {
          prec = obj.precision;
        }
        var unit = getChUnit(id, "");
        if (null == prec) prec = 1;

        if (null != val[id].avg) {
          if (create) {
            $("#hourTable").append(
              '<tr><th class="right">' +
                title +
                "</th>" +
                '<td id="' +
                id +
                '_min">' +
                magnumTemperature(val[id].min) +
                "</td>" +
                '<td id="' +
                id +
                '_max">' +
                magnumTemperature(val[id].max) +
                "</td>" +
                '<td id="' +
                id +
                '_avg">' +
                magnumTemperature(val[id].avg) +
                "</td></tr>"
            );
          } else {
            $("#" + id + "_min").html(magnumTemperature(val[id].min));
            $("#" + id + "_max").html(magnumTemperature(val[id].max));
            $("#" + id + "_avg").html(magnumTemperature(val[id].avg));
          }
        }
      }

      function updateHourRowTempAGS(tableID, id, title, val, create) {
        var obj = getChObj(id);
        var prec = 2;

        if (null != obj) {
          prec = obj.precision;
        }
        var unit = getChUnit(id, "");
        if (null == prec) prec = 1;

        if (250 < val[id].max || 0 == val[id].min) {
          if (create) {
            $("#" + tableID).append(
              '<tr id="hour_' +
                id +
                '">' +
                '<th class="right">' +
                title +
                "</th>" +
                '<td colspan = "3"><i>Was Disconnected...</i></td></tr>'
            );
          } else {
            $("#hour_" + id).html(
              '<th class="right">' +
                title +
                "</th>" +
                '<td colspan = "3"><i>Was Disconnected...</i></td>'
            );
          }

          return;
        } else {
          if (create) {
            $("#hourTable").append(
              '<tr><th class="right">' +
                title +
                "</th>" +
                '<td id="' +
                id +
                '_min">' +
                magnumAGSTemperature(val[id].min) +
                "</td>" +
                '<td id="' +
                id +
                '_max">' +
                magnumAGSTemperature(val[id].max) +
                "</td>" +
                '<td id="' +
                id +
                '_avg">' +
                magnumAGSTemperature(val[id].avg) +
                "</td></tr>"
            );
          } else {
            $("#" + id + "_min").html(magnumAGSTemperature(val[id].min));
            $("#" + id + "_max").html(magnumAGSTemperature(val[id].max));
            $("#" + id + "_avg").html(magnumAGSTemperature(val[id].avg));
          }
        }
      }

      function addHourLineSpec(tableID, id, title, val, create) {
        var chObj = getChObj(id);

        /* if channel exists */
        if (null != chObj && null != val[id]) {
          var unit = getChUnit(id, "");
          /* if max is 5e-324 then that means we don't have data for that channel, which is not an error, it just means the inverter doesn't have a feature that others might have */
          if (val[id].max != 5e-324) {
            var prec = chObj.precision;

            if ("b_state_of_charge" == id && 100 < val[id].max) {
              if (create) {
                $("#" + tableID).append(
                  '<tr id="hour_' +
                    id +
                    '">' +
                    '<th class="right">' +
                    title +
                    "</th>" +
                    '<td colspan = "3"><i>BMK Was Thinking...</i></td></tr>'
                );
              } else {
                $("#hour_" + id).html(
                  '<th class="right">' +
                    title +
                    "</th>" +
                    '<td colspan = "3"><i>BMK Was Thinking...</i></td>'
                );
              }

              return;
            }
            if (250 < val[id].max) {
              if (create) {
                $("#" + tableID).append(
                  '<tr id="hour_' +
                    id +
                    '">' +
                    '<th class="right">' +
                    title +
                    "</th>" +
                    '<td colspan = "3"><i>Was Disconnected...</i></td></tr>'
                );
              } else {
                $("#hour_" + id).html(
                  '<th class="right">' +
                    title +
                    "</th>" +
                    '<td colspan = "3"><i>Was Disconnected...</i></td>'
                );
              }
              return;
            }
            addHourLine(tableID, id, title, val, create);
          }
        }
      }

      function addHourLine(tableID, id, title, val, create) {
        var chObj = getChObj(id);
        /* if channel exists */
        if (null != chObj && null != val[id]) {
          var unit = ""; //getChUnit(id,"");
          if ("b_state_of_charge_clean" == id) {
            unit = "%";
          }
          /* if max is 5e-324 then that means we don't have data for that channel, which is not an error, it just means the inverter doesn't have a feature that others might have */
          if (val[id].max != -1.7976931348623157e308) {
            var prec = chObj.precision;

            if (create) {
              $("#" + tableID).append(
                '<tr id="hour_' +
                  id +
                  '">' +
                  '<th class="right">' +
                  title +
                  "</th>" +
                  "<td>" +
                  val[id].min.toFixed(prec) +
                  unit +
                  "</td>" +
                  "<td>" +
                  val[id].max.toFixed(prec) +
                  unit +
                  "</td>" +
                  "<td>" +
                  val[id].avg.toFixed(prec) +
                  unit +
                  "</td></tr>"
              );
            } else {
              $("#hour_" + id).html(
                '<th class="right">' +
                  title +
                  "</th>" +
                  "<td>" +
                  val[id].min.toFixed(prec) +
                  unit +
                  "</td>" +
                  "<td>" +
                  val[id].max.toFixed(prec) +
                  unit +
                  "</td>" +
                  "<td>" +
                  val[id].avg.toFixed(prec) +
                  unit +
                  "</td>"
              );
            }
          }
        }
      }

      /* loads the history json to create the 24 hour data as well as the striplines */
      function loadHistory() {
        $("#loadingContainer").show();
        $("#loadingMsg").html("Loading...");

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              dataS = $.parseJSON(xhr.responseText);

              processHist(dataS);
            } else {
              console.error("Error:", xhr.status);
              noResponse = true;
              customFaults(null);
            }
          }
        };
        xhr.open("GET", "/history.json", true);
        xhr.send();
      }

      /* processes the history json into 24 hour data and arrays for the striplines */
      function processHist(hist) {
        if (0 == hist.recent.length) {
          setTimeout(loadHistory, 10000);
          return;
        }

        var color_green;
        var color_yellow = "#f7a11a";
        var color_red;

        var d = new Date();
        var n = d.getTime();

        var oldestTime;
        var mostRecentTime;

        var count = 0;

        var hourChannels = [];

        /* iterate through the history object array */

        var histAr = hist.recent;
        //$. each (hist.history, function (packet, entry) {
        $("#loadingMsg").html("Loading BMK charts...");
        for (var i = 0; i < histAr.length; i++) {
          /* add data to the flot chart arrays */
          if (null != histAr[i].data.b_state_of_charge)
            data.b_state_array.push([
              histAr[i].time,
              histAr[i].data.b_state_of_charge,
            ]);
          if (null != histAr[i].data.b_dc_watts)
            data.b_watts.push([histAr[i].time, histAr[i].data.b_dc_watts]);
          if (null != histAr[i].data.b_amph_in_out)
            data.amp_in_out.push([
              histAr[i].time,
              histAr[i].data.b_amph_in_out,
            ]);
          if (null != histAr[i].data.calc_add_power)
            data.calc.push([histAr[i].time, histAr[i].data.calc_add_power]);
        }

        loadDataCreate();
      }

      /* plots the graphs */
      function plotGraphs() {
        $("#loadingContainer").hide();

        /* take data from the json and put it in an array suitable for flot */
        if (0 != data.b_state_array.length) {
          var dataArray = data.b_state_array;

          dataArray = tenMinuteAverages(dataArray);

          for (var i = 0; i < dataArray.length; i++) {
            battArray[i] = [i, dataArray[i]];
          }
          while (battArray.length <= 144) {
            battArray.push([-battArray.length, 0]);
          }

          /* options for flot */
          var optionsEditSpark = {
            series: {
              shadowSize: 0,
            },
            grid: {
              borderWidth: 0,
              show: true,
              hoverable: true,
              autoHighlight: false,
            },
            xaxis: {
              ticks: 0,
              tickLength: 0,
            },
            yaxis: {
              max: 100,
              min: 0,
              ticks: 2,
              tickLength: 0,
            },
          };
          /* data for flot */
          var data2 = [
            {
              data: battArray,
              bars: {
                show: true,
                lineWidth: 0,
                barWidth: 0.5,
                align: "left",
                fill: 1,
              },
              color: "#808080",
              threshold: [
                {
                  below: 101,
                  color: "#008000",
                },
              ],
            },
          ];
          /* plot the flot chart */
          $.plot("#chargeChart", data2, optionsEditSpark);
        }

        /* take data from the json and put it in an array suitable for flot */
        if (0 != data.b_watts.length) {
          dataArray = data.b_watts;
          dataArray = tenMinuteAverages(dataArray);
          for (var i = 0; i < dataArray.length; i++) {
            voltsArray[i] = [i, dataArray[i]];
          }
          while (voltsArray.length <= 144) {
            voltsArray.push([-voltsArray.length, 0]);
          }
          /* plot the flot chart */
          $.plot(
            "#voltsChart",
            [
              {
                data: voltsArray,
                bars: {
                  show: true,
                  lineWidth: 0,
                  barWidth: 0.5,
                  align: "left",
                  fill: 1,
                },
                color: "#000000",
                threshold: [
                  {
                    below: 0,
                    color: "#f04040",
                  },
                ],
              },
            ],
            {
              grid: {
                borderWidth: 0,
                hoverable: true,
                autoHighlight: false,
              },
              xaxis: {
                tickLength: 0,
                ticks: 0,
              },
              yaxis: {
                tickLength: 0,
                ticks: 3,
              },
            }
          );
        }
        /* take data from the json and put it in an array suitable for flot */
        if (0 != data.amp_in_out.length) {
          dataArray = data.amp_in_out;
          dataArray = tenMinuteAverages(dataArray);
          for (var i = 0; i < dataArray.length; i++) {
            ampArray[i] = [i, dataArray[i]];
          }
          while (ampArray.length <= 144) {
            ampArray.push([-ampArray.length, 0]);
          }
          /* plot the flot chart */
          $.plot(
            "#ampChart",
            [
              {
                data: ampArray,
                bars: {
                  show: true,
                  lineWidth: 0,
                  barWidth: 0.5,
                  align: "left",
                  fill: 1,
                },
                color: "#000000",
                threshold: [
                  {
                    below: 0,
                    color: "#f04040",
                  },
                  {
                    below: 0,
                    color: "#f7a11a",
                  },
                ],
              },
            ],
            {
              grid: {
                borderWidth: 0,
                hoverable: true,
                autoHighlight: false,
              },
              xaxis: {
                tickLength: 0,
                ticks: 0,
              },
              yaxis: {
                tickLength: 0,
                ticks: 3,
              },
            }
          );
        }
        if (0 != data.calc.length) {
          dataArray = data.calc;
          dataArray = tenMinuteAverages(dataArray);
          for (var i = 0; i < dataArray.length; i++) {
            calcArray[i] = [i, dataArray[i]];
          }
          while (calcArray.length <= 144) {
            calcArray.push([-calcArray.length, 0]);
          }

          /* plot the flot chart */
          /*$.plot("#calcChart", [{
      				data: calcArray,
      				bars: {
      					show: true,
      					lineWidth:0,
      					barWidth: .5,
      					align: "left",
      					fill: 1
      				},
      				color: '#000000',
      				threshold: [{
      					below: 0,
      					color: '#f04040'
      				}, {
      					below: 0,
      					color: '#f7a11a'
      				}]
      			}], {
      				grid: {
      					borderWidth: 0,
      					hoverable: true,
      					autoHighlight: false
      				},
      				xaxis: {
      					tickLength: 0,
      					ticks:0
      				},
      				yaxis: {
      					tickLength: 0,
      					ticks: 3
      				}
      		});*/
        }
      }

      /* find the ten minute averages for flot charts */
      function tenMinuteAverages(notAvgArray) {
        var avgArray = [];
        var j = 0;
        var i = 0;
        avgArray[j] = 0;
        var timeDiff = 600000; // ten minutes to milliseconds
        var count = 0;

        /* get first timestamp */

        if (notAvgArray) var startTime = notAvgArray[0][0];

        /* initialize array */
        avgArray[0] = 0;

        /* iterate through notAvgArray and take the average of every 60 */
        for (i = 0; i < notAvgArray.length; i++) {
          /* if packet time is more than ten minutes difference to the the startTime */
          if (notAvgArray[i][0] > startTime + timeDiff) {
            /* if count is not zero, we find the average */
            if (0 != count) {
              avgArray[j] /= count;
              count = 0;
              j++;
              avgArray[j] = 0;
              startTime += timeDiff;
            } else {
              /* if count IS 0, then we have no data for that ten minutes and we just put a zero */
              j++;
              avgArray[j] = 0;
              startTime += timeDiff;
            }
          }
          /* add value and increment count */
          avgArray[j] += parseFloat(notAvgArray[i][1]);
          count++;
        }
        /* get last average */

        avgArray[j] /= count;

        /* return averaged array */
        return avgArray;
      }

      /* this is the timer that keeps the page updating. */
      function timerTick() {
        da = new Date();

        /* increment seconds */
        seconds++;

        /* update the timer on the bottom of the screen and the timer at the top of the table */
        $("#age").html(commaSeparateNumber(seconds));
        $("#ageRep").html(commaSeparateNumber(seconds));

        /* This will check the server for new data every ten seconds. note that it checks when seconds mod 10 equals 1. This is because when seconds%10==0 was used
      		it would tend to miss getting new data almost everytime. */
        if (seconds % 10 == 1 && seconds != 1) {
          loadData();
        }
        /* here, if there was no new data, it checks seconds%10==5, giving it 5 extra seconds and checking the server again. This was added to fix a problem where sometimes
      		seconds would miss an update, keep going until twice the update time, then update twice in a row. This is double checking if the data is actually
      		old or if it checked too early */
        if (seconds > 10 && seconds % 10 == 5) {
          loadData();
        }

        updateHeadline();

        setTimeout(timerTick, 1000);
      }

      /* separates a number with commas if over 1,000 */
      function commaSeparateNumber(val) {
        if (null != val) {
          while (/(\d+)(\d{3})/.test(val.toString())) {
            val = val.toString().replace(/(\d+)(\d{3})/, "$1" + "," + "$2");
          }
        }
        return val;
      }

      /* hides div with the id of warning */
      function hideWarn() {
        $("#connection_warn").hide();
      }

      function getUTCTime(val) {
        var now = new Date(val);
        var now_utc = new Date(
          now.getUTCFullYear(),
          now.getUTCMonth(),
          now.getUTCDate(),
          now.getUTCHours(),
          now.getUTCMinutes(),
          now.getUTCSeconds()
        );
        return now_utc.toString("yyyy-MM-dd HH:mm:ss");
      }

      function toggleMemPos() {
        if ("-210px" == $("#memoryData").css("bottom")) {
          MemUp();
        } else {
          MemDown();
        }
      }

      function MemUp() {
        $("#memoryData").animate({ bottom: "50px" }, "fast");
      }

      function MemDown() {
        $("#memoryData").animate({ bottom: "-210px" }, "fast");
      }

      function toggleAlarmPos() {
        if ("-260px" == $("#alarmControl").css("bottom")) {
          alarmUp();
        } else {
          alarmDown();
        }
      }
      function alarmUp() {
        $("#alarmControl").animate({ bottom: "50px" }, "fast");
      }

      function alarmDown() {
        $("#alarmControl").animate({ bottom: "-260px" }, "fast");
      }

      $(document).ready(function () {
        /* The bar doesn't work well on ipods  */
        if (navigator.platform == "iPhone" || navigator.platform == "iPod") {
          $("#bar").hide();
        }

        $.ajaxSetup({ cache: false });

        /* this will shoot off a request to the server when the window is refocused */
        $(window).focus(function () {
          //loadData();
        });
        /* ajax error listener */
        $(document).ajaxError(function (event) {
          //$("#connection_warn").show();
          $("#connection_warn").append(event);
          noResponse = true;
          customFaults(null);
        });
        /* request data and start timer */
        //loadData();
        loadHeadline();
        loadChannelData();
      });
    </script>

    <div
      id="bar"
      style="
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        z-index: 2;
        background: #e0e0e0;
        text-align: center;
      "
    >
      <span id="bottomar" style="margin-left: 10px; float: left"
        >Data from approximately <span id="age">Loading...</span> seconds
        ago</span
      >
    </div>

    <div style="text-align: center" id="loadingContainer">
      <h1 id="loadingMsg"></h1>
    </div>

    <div
      id="alarm"
      style="
        text-align: center;
        font-size: 1.5em;
        padding: 5px;
        margin-left: 75px;
        margin-right: 75px;
        font-weight: bold;
        display: none;
      "
    >
      <p id="alarmMessage">The inverter has faulted!</p>
    </div>
    <div
      id="connection_warn"
      style="
        text-align: center;
        width: 800px;
        margin-right: auto;
        margin-left: auto;
        background-color: orange;
        color: white;
        display: none;
      "
      onclick="hideWarn()"
    >
      <h1>
        No Response From Server. Please check to make sure you are still
        connected to the internet
      </h1>
    </div>

    <div
      id="notConnected"
      style="
        text-align: center;
        width: 800px;
        margin-right: auto;
        margin-left: auto;
        color: white;
        display: none;
      "
    >
      <h1>MagWeb Online But Not Connected To Inverter System</h1>
    </div>

    <div id="memoryData" onclick="toggleMemPos()">
      <div>
        <span
          id="memWarn"
          style="
            color: white;
            text-align: center;
            font-size: 1.5em;
            display: none;
          "
          ><img
            src="res/images/Exclamation.64.png"
            alt="Exclamation"
          /><br />Memory Low</span
        >
        <h3 style="color: #ffffff; padding-bottom: 10px">
          Memory<br /><span style="font-size: 0.75em">click to show/hide</span>
        </h3>
      </div>

      <table id="memTable">
        <tr style="display: none" class="usbRow">
          <td colspan="2" style="text-align: center" id="usbMsg">
            External Storage is inserted
          </td>
        </tr>
        <tr style="display: none">
          <td></td>
          <td></td>
        </tr>
        <tr>
          <th style="background-color: #303030" colspan="2">System Memory</th>
        </tr>
      </table>
    </div>

    <div
      id="tables"
      style="display: table; margin-left: auto; margin-right: auto; width: 70%"
    >
      <div style="width: 50%; display: table-cell">
        <table
          id="currentTable"
          style="width: 95%; margin-left: auto; margin-right: auto"
        ></table>
      </div>

      <div style="width: 50%; display: table-cell">
        <table
          id="hourTable"
          style="width: 95%; margin-left: auto; margin-right: auto"
        ></table>
      </div>
    </div>
    <div style="clear: both">
      <div id="sound_element"></div>
    </div>
    <span id="preloadedImages"></span>

    <br />
    <br />
    <div style="text-align: center; padding-bottom: 50px">
      <h5 style="color: #666">
        &copy; 2015. All rights reserved.<br /><br />
        <em
          >Powered by an
          <a target="_blank" href="http://www.aprsworld.com/">APRS World</a>
          solution.</em
        >
      </h5>
    </div>
  </body>
</html>
